<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/flashcardapp/SigninActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/flashcardapp/SigninActivity.kt" />
              <option name="originalContent" value="package com.example.flashcardapp&#10;&#10;import android.content.Intent&#10;import android.os.Bundle&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.appcompat.app.AppCompatActivity&#10;import androidx.lifecycle.lifecycleScope&#10;import com.example.flashcardapp.databinding.SignInBinding&#10;import com.example.flashcardapp.model.User&#10;import io.github.jan.supabase.auth.auth&#10;import io.github.jan.supabase.auth.providers.builtin.Email&#10;import io.github.jan.supabase.postgrest.from&#10;import kotlinx.coroutines.launch&#10;import java.time.LocalDate&#10;import java.time.OffsetDateTime&#10;import java.time.ZoneOffset&#10;import java.time.format.DateTimeParseException&#10;import kotlinx.serialization.json.buildJsonObject&#10;import kotlinx.serialization.json.put&#10;import kotlinx.serialization.json.JsonPrimitive&#10;&#10;class SigninActivity : AppCompatActivity() {&#10;    lateinit var binding: SignInBinding&#10;&#10;    companion object {&#10;        private const val TAG = &quot;SigninActivity&quot;&#10;        const val EXTRA_USERNAME = &quot;extra_username&quot;&#10;        const val EXTRA_USER_ID = &quot;extra_user_id&quot;&#10;    }&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        binding = SignInBinding.inflate(layoutInflater)&#10;        setContentView(binding.root)&#10;&#10;        // Navigate to SignUp when &quot;No register yet&quot; button is clicked&#10;        binding.noRegisterButton.setOnClickListener {&#10;            Log.d(TAG, &quot;No register button clicked, navigating to SignUpActivity&quot;)&#10;            val intent = Intent(this, SignUpActivity::class.java)&#10;            startActivity(intent)&#10;            finish()&#10;        }&#10;&#10;        // Navigate to ForgotPassword when reset password button is clicked&#10;        binding.resetPasswordButton.setOnClickListener {&#10;            Log.d(TAG, &quot;Reset password button clicked, navigating to ForgotPasswordActivity&quot;)&#10;            val intent = Intent(this, ForgotPasswordActivity::class.java)&#10;            startActivity(intent)&#10;        }&#10;&#10;        // Sign in button click listener&#10;        binding.signInButton.setOnClickListener {&#10;            val email = binding.emailInput.text?.toString()?.trim() ?: &quot;&quot;&#10;            val password = binding.passwordInput.text?.toString() ?: &quot;&quot;&#10;&#10;            // Basic validation&#10;            if (email.isEmpty() || password.isEmpty()) {&#10;                Toast.makeText(this, &quot;Please fill all fields&quot;, Toast.LENGTH_SHORT).show()&#10;                return@setOnClickListener&#10;            }&#10;&#10;            // Perform sign-in with Supabase&#10;            signIn(email, password)&#10;        }&#10;    }&#10;&#10;    private fun signIn(email: String, password: String) {&#10;        Log.d(TAG, &quot;Sign in attempt for email: $email&quot;)&#10;        lifecycleScope.launch {&#10;            try {&#10;                Log.d(TAG, &quot;Attempting authentication with Supabase...&quot;)&#10;                SupabaseProvider.client.auth.signInWith(Email) {&#10;                    this.email = email&#10;                    this.password = password&#10;                }&#10;                Log.d(TAG, &quot;Authentication successful&quot;)&#10;&#10;                // Get the authenticated user ID&#10;                val userId = SupabaseProvider.client.auth.currentUserOrNull()?.id&#10;                Log.d(TAG, &quot;Retrieved user ID: $userId&quot;)&#10;&#10;                if (userId == null) {&#10;                    Log.e(TAG, &quot;Failed to get user ID after successful authentication&quot;)&#10;                    Toast.makeText(this@SigninActivity, &quot;Failed to get user ID&quot;, Toast.LENGTH_SHORT).show()&#10;                    return@launch&#10;                }&#10;&#10;                // Retrieve user data from the User table&#10;                Log.d(TAG, &quot;Fetching user data from database for user ID: $userId&quot;)&#10;                val userList = SupabaseProvider.client.from(&quot;User&quot;)&#10;                    .select {&#10;                        filter {&#10;                            eq(&quot;user_id&quot;, userId)&#10;                        }&#10;                    }&#10;                    .decodeList&lt;User&gt;()&#10;&#10;                Log.d(TAG, &quot;User data retrieved. Count: ${userList.size}&quot;)&#10;&#10;                if (userList.isNotEmpty()) {&#10;                    val user = userList.first()&#10;                    Log.d(TAG, &quot;Sign in successful for user: ${user.username}&quot;)&#10;&#10;                    // Compare lastime_access (date only) with today UTC&#10;                    val now = OffsetDateTime.now(ZoneOffset.UTC)&#10;                    val todayUtc = now.toLocalDate()&#10;                    val yesterdayUtc = todayUtc.minusDays(1)&#10;                    val lastDate: LocalDate? = try {&#10;                        user.lastime_access?.let { OffsetDateTime.parse(it).toLocalDate() }&#10;                    } catch (e: DateTimeParseException) {&#10;                        Log.w(TAG, &quot;Failed to parse lastime_access='${user.lastime_access}', will treat as no recent access&quot;, e)&#10;                        null&#10;                    }&#10;&#10;                    // Initialize currentStreak from DB&#10;                    var currentStreak = user.streak ?: 0&#10;&#10;                    when {&#10;                        lastDate == todayUtc -&gt; {&#10;                            Log.d(TAG, &quot;Last access is today; no streak update.&quot;)&#10;                            // streak remains as fetched from DB&#10;                        }&#10;                        lastDate == yesterdayUtc -&gt; {&#10;                            // Exactly yesterday: increment streak and update lastime_access to now&#10;                            currentStreak += 1&#10;                            Log.d(TAG, &quot;Yesterday login detected. Incrementing streak to $currentStreak and updating lastime_access to $now&quot;)&#10;                            try {&#10;                                val payload = buildJsonObject {&#10;                                    put(&quot;streak&quot;, JsonPrimitive(currentStreak))&#10;                                    put(&quot;lastime_access&quot;, JsonPrimitive(now.toString()))&#10;                                }&#10;                                SupabaseProvider.client.from(&quot;User&quot;).update(payload) {&#10;                                    filter { eq(&quot;user_id&quot;, userId) }&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                Log.e(TAG, &quot;Failed to update streak/lastime_access: ${e.message}&quot;, e)&#10;                            }&#10;                        }&#10;                        else -&gt; {&#10;                            // Not yesterday or today: reset streak to 0 and update lastime_access&#10;                            currentStreak = 0&#10;                            Log.d(TAG, &quot;Last access not yesterday or today (lastDate=$lastDate). Resetting streak to 0 and updating lastime_access to $now&quot;)&#10;                            try {&#10;                                val payload = buildJsonObject {&#10;                                    put(&quot;streak&quot;, JsonPrimitive(currentStreak))&#10;                                    put(&quot;lastime_access&quot;, JsonPrimitive(now.toString()))&#10;                                }&#10;                                SupabaseProvider.client.from(&quot;User&quot;).update(payload) {&#10;                                    filter { eq(&quot;user_id&quot;, userId) }&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                Log.e(TAG, &quot;Failed to reset streak/update lastime_access: ${e.message}&quot;, e)&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    Toast.makeText(this@SigninActivity, &quot;Welcome ${user.username}!&quot;, Toast.LENGTH_SHORT).show()&#10;&#10;                    // Set globals&#10;                    UserSession.userId = userId&#10;                    UserSession.username = user.username&#10;                    UserSession.streak = currentStreak&#10;&#10;                    // Navigate to MainLayoutActivity and pass extras&#10;                    val intent = Intent(this@SigninActivity, MainLayoutActivity::class.java)&#10;                    intent.putExtra(EXTRA_USERNAME, user.username)&#10;                    intent.putExtra(EXTRA_USER_ID, userId)&#10;                    startActivity(intent)&#10;                    finish()&#10;                } else {&#10;                    Log.e(TAG, &quot;User data not found in database for user ID: $userId&quot;)&#10;                    Toast.makeText(this@SigninActivity, &quot;User data not found&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;Sign in failed with exception: ${e::class.simpleName}&quot;, e)&#10;                Log.e(TAG, &quot;Error message: ${e.message}&quot;)&#10;                Log.e(TAG, &quot;Stack trace:&quot;, e)&#10;                Toast.makeText(this@SigninActivity, &quot;Sign in failed: ${e.message}&quot;, Toast.LENGTH_LONG).show()&#10;            }&#10;        }&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.flashcardapp&#10;&#10;import android.content.Intent&#10;import android.os.Bundle&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.appcompat.app.AppCompatActivity&#10;import androidx.lifecycle.lifecycleScope&#10;import com.example.flashcardapp.databinding.SignInBinding&#10;import com.example.flashcardapp.model.User&#10;import io.github.jan.supabase.auth.auth&#10;import io.github.jan.supabase.auth.providers.builtin.Email&#10;import io.github.jan.supabase.postgrest.from&#10;import kotlinx.coroutines.launch&#10;import java.time.LocalDate&#10;import java.time.OffsetDateTime&#10;import java.time.ZoneOffset&#10;import java.time.format.DateTimeParseException&#10;import kotlinx.serialization.json.buildJsonObject&#10;import kotlinx.serialization.json.put&#10;import kotlinx.serialization.json.JsonPrimitive&#10;&#10;class SigninActivity : AppCompatActivity() {&#10;    lateinit var binding: SignInBinding&#10;&#10;    companion object {&#10;        private const val TAG = &quot;SigninActivity&quot;&#10;        const val EXTRA_USERNAME = &quot;extra_username&quot;&#10;        const val EXTRA_USER_ID = &quot;extra_user_id&quot;&#10;    }&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        binding = SignInBinding.inflate(layoutInflater)&#10;        setContentView(binding.root)&#10;&#10;        // Navigate to SignUp when &quot;No register yet&quot; button is clicked&#10;        binding.noRegisterButton.setOnClickListener {&#10;            Log.d(TAG, &quot;No register button clicked, navigating to SignUpActivity&quot;)&#10;            val intent = Intent(this, SignUpActivity::class.java)&#10;            startActivity(intent)&#10;            finish()&#10;        }&#10;&#10;        // Navigate to ForgotPassword when reset password button is clicked&#10;        binding.resetPasswordButton.setOnClickListener {&#10;            Log.d(TAG, &quot;Reset password button clicked, navigating to ForgotPasswordActivity&quot;)&#10;            val intent = Intent(this, ForgotPasswordActivity::class.java)&#10;            startActivity(intent)&#10;        }&#10;&#10;        // Sign in button click listener&#10;        binding.signInButton.setOnClickListener {&#10;            val email = binding.emailInput.text?.toString()?.trim() ?: &quot;&quot;&#10;            val password = binding.passwordInput.text?.toString() ?: &quot;&quot;&#10;&#10;            // Basic validation&#10;            if (email.isEmpty() || password.isEmpty()) {&#10;                Toast.makeText(this, &quot;Please fill all fields&quot;, Toast.LENGTH_SHORT).show()&#10;                return@setOnClickListener&#10;            }&#10;&#10;            // Perform sign-in with Supabase&#10;            signIn(email, password)&#10;        }&#10;    }&#10;&#10;    private fun signIn(email: String, password: String) {&#10;        Log.d(TAG, &quot;Sign in attempt for email: $email&quot;)&#10;        lifecycleScope.launch {&#10;            try {&#10;                Log.d(TAG, &quot;Attempting authentication with Supabase...&quot;)&#10;                SupabaseProvider.client.auth.signInWith(Email) {&#10;                    this.email = email&#10;                    this.password = password&#10;                }&#10;                Log.d(TAG, &quot;Authentication successful&quot;)&#10;&#10;                // Get the authenticated user ID&#10;                val userId = SupabaseProvider.client.auth.currentUserOrNull()?.id&#10;                Log.d(TAG, &quot;Retrieved user ID: $userId&quot;)&#10;&#10;                if (userId == null) {&#10;                    Log.e(TAG, &quot;Failed to get user ID after successful authentication&quot;)&#10;                    Toast.makeText(this@SigninActivity, &quot;Failed to get user ID&quot;, Toast.LENGTH_SHORT).show()&#10;                    return@launch&#10;                }&#10;&#10;                // Retrieve user data from the User table&#10;                Log.d(TAG, &quot;Fetching user data from database for user ID: $userId&quot;)&#10;                val userList = SupabaseProvider.client.from(&quot;User&quot;)&#10;                    .select {&#10;                        filter {&#10;                            eq(&quot;user_id&quot;, userId)&#10;                        }&#10;                    }&#10;                    .decodeList&lt;User&gt;()&#10;&#10;                Log.d(TAG, &quot;User data retrieved. Count: ${userList.size}&quot;)&#10;&#10;                if (userList.isNotEmpty()) {&#10;                    val user = userList.first()&#10;                    Log.d(TAG, &quot;Sign in successful for user: ${user.username}&quot;)&#10;&#10;                    // Compare lastime_access (date only) with today UTC&#10;                    val now = OffsetDateTime.now(ZoneOffset.UTC)&#10;                    val todayUtc = now.toLocalDate()&#10;                    val yesterdayUtc = todayUtc.minusDays(1)&#10;                    val lastDate: LocalDate? = try {&#10;                        user.lastime_access?.let { OffsetDateTime.parse(it).toLocalDate() }&#10;                    } catch (e: DateTimeParseException) {&#10;                        Log.w(TAG, &quot;Failed to parse lastime_access='${user.lastime_access}', will treat as no recent access&quot;, e)&#10;                        null&#10;                    }&#10;&#10;                    // Initialize currentStreak from DB&#10;                    var currentStreak = user.streak ?: 0&#10;&#10;                    when {&#10;                        lastDate == todayUtc -&gt; {&#10;                            Log.d(TAG, &quot;Last access is today; no streak update.&quot;)&#10;                            // streak remains as fetched from DB&#10;                        }&#10;                        lastDate == yesterdayUtc -&gt; {&#10;                            // Exactly yesterday: increment streak and update lastime_access to now&#10;                            currentStreak += 1&#10;                            Log.d(TAG, &quot;Yesterday login detected. Incrementing streak to $currentStreak and updating lastime_access to $now&quot;)&#10;                            try {&#10;                                val payload = buildJsonObject {&#10;                                    put(&quot;streak&quot;, JsonPrimitive(currentStreak))&#10;                                    put(&quot;lastime_access&quot;, JsonPrimitive(now.toString()))&#10;                                }&#10;                                SupabaseProvider.client.from(&quot;User&quot;).update(payload) {&#10;                                    filter { eq(&quot;user_id&quot;, userId) }&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                Log.e(TAG, &quot;Failed to update streak/lastime_access: ${e.message}&quot;, e)&#10;                            }&#10;                        }&#10;                        else -&gt; {&#10;                            // Not yesterday or today: reset streak to 0 and update lastime_access&#10;                            currentStreak = 0&#10;                            Log.d(TAG, &quot;Last access not yesterday or today (lastDate=$lastDate). Resetting streak to 0 and updating lastime_access to $now&quot;)&#10;                            try {&#10;                                val payload = buildJsonObject {&#10;                                    put(&quot;streak&quot;, JsonPrimitive(currentStreak))&#10;                                    put(&quot;lastime_access&quot;, JsonPrimitive(now.toString()))&#10;                                }&#10;                                SupabaseProvider.client.from(&quot;User&quot;).update(payload) {&#10;                                    filter { eq(&quot;user_id&quot;, userId) }&#10;                                }&#10;                            } catch (e: Exception) {&#10;                                Log.e(TAG, &quot;Failed to reset streak/update lastime_access: ${e.message}&quot;, e)&#10;                            }&#10;                        }&#10;                    }&#10;&#10;                    Toast.makeText(this@SigninActivity, &quot;Welcome ${user.username}!&quot;, Toast.LENGTH_SHORT).show()&#10;&#10;                    // Set globals&#10;                    UserSession.userId = userId&#10;                    UserSession.username = user.username&#10;                    UserSession.streak = currentStreak&#10;&#10;                    // Navigate to MainLayoutActivity and pass extras&#10;                    val intent = Intent(this@SigninActivity, MainLayoutActivity::class.java)&#10;                    intent.putExtra(EXTRA_USERNAME, user.username)&#10;                    intent.putExtra(EXTRA_USER_ID, userId)&#10;                    startActivity(intent)&#10;                    finish()&#10;                } else {&#10;                    Log.e(TAG, &quot;User data not found in database for user ID: $userId&quot;)&#10;                    Toast.makeText(this@SigninActivity, &quot;User data not found&quot;, Toast.LENGTH_SHORT).show()&#10;                }&#10;&#10;            } catch (e: Exception) {&#10;                Log.e(TAG, &quot;Sign in failed with exception: ${e::class.simpleName}&quot;, e)&#10;                Log.e(TAG, &quot;Error message: ${e.message}&quot;)&#10;                Log.e(TAG, &quot;Stack trace:&quot;, e)&#10;                Toast.makeText(this@SigninActivity, &quot;Sign in failed: ${e.message}&quot;, Toast.LENGTH_LONG).show()&#10;            }&#10;        }&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>